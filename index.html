<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>LegislaFácil</title>
  <link rel="icon" href="https://raw.githubusercontent.com/google/material-design-icons/master/png/image_folder/materialicons/book_black_48dp.png" type="image/png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            law: {
              navy: "#0B1C3F",
              navy2: "#122553",
              gold: "#C8A356",
            },
          },
          boxShadow: {
            soft: "0 8px 24px rgba(2,6,23,.08)",
          },
          fontFamily: {
            inter: ["Inter", "system-ui", "sans-serif"],
            merri: ["Merriweather", "serif"],
          },
        },
      },
    };
  </script>
  <style>
    body{font-family:"Inter",system-ui,sans-serif}
    /* Sem @apply para compatibilidade total com Tailwind via CDN */
    th, td { padding-top: .75rem; padding-bottom: .75rem; text-align: left; }

    /* Larguras responsivas com colgroup (mais robusto que nth-child + @apply) */
    col.col-ano      { width: 6%;  }
    col.col-numero   { width: 8%;  }
    col.col-tipo     { width: 10%; }
    col.col-categoria{ width: 12%; }
    col.col-descricao{ width: 50%; }
    col.col-link     { width: 14%; }

    /* Scrollbar do painel de resultados */
    .scroll-area::-webkit-scrollbar { width: 8px; height: 8px; }
    .scroll-area::-webkit-scrollbar-track { background:#e5e7eb; border-radius:10px; }
    .scroll-area::-webkit-scrollbar-thumb { background:#9ca3af; border-radius:10px; }
    .scroll-area::-webkit-scrollbar-thumb:hover { background:#6b7280; }

    mark { background: #fde68a; padding: 0 .15em; border-radius: .2rem; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 p-4 sm:p-6 flex flex-col items-center justify-center">

  <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-soft w-full max-w-7xl border border-slate-200 flex flex-col h-[90vh]">
    <!-- Topo fixo (não rola) -->
    <div class="flex-shrink-0">
      <div class="mb-6">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-law-navy font-merri tracking-tight">
          <span class="inline-flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-law-gold" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-2.21 0-4 1.79-4 4v1H6a3 3 0 00-3 3v2h2.09a5 5 0 009.82 0H17V11a3 3 0 00-3-3h-2V7c0-1.1.9-2 2-2h4V3h-6zm-5 9a3 3 0 116 0H7zM4 17h16v2H4v-2z"/></svg>
            Legislação Brasileira — Principais Normas
          </span>
        </h1>
        <p class="text-center text-slate-600 text-sm mt-2">
          Projeto desenvolvido por <span class="font-semibold">Danilo Brandão</span>, Graduando em Direito pela FADIMAB.
        </p>
      </div>

      <div class="mb-6 text-center space-y-2">
        <p id="loadingMessage" class="text-law-navy font-medium animate-pulse hidden">Carregando dados da planilha…</p>
        <p id="errorMessage" class="text-red-600 font-medium hidden"></p>
        <p id="localFileWarning" class="text-amber-700 text-sm p-2 bg-amber-50 rounded-lg border border-amber-200 hidden">
          ⚠️ Se você abriu este arquivo via <code>file://</code>, a busca pode não funcionar por CORS. Rode um servidor local (ex.: <code>python -m http.server</code>).
        </p>
      </div>

      <!-- Filtros -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
        <div class="flex flex-col">
          <label for="ano" class="text-slate-700 text-sm font-semibold mb-1">Ano:</label>
          <select id="ano" class="p-3 border border-slate-300 rounded-lg focus:ring-law-navy focus:border-law-navy transition shadow-sm hover:shadow w-full text-slate-800"></select>
        </div>

        <div class="flex flex-col">
          <label for="tipo" class="text-slate-700 text-sm font-semibold mb-1">Tipo:</label>
          <select id="tipo" class="p-3 border border-slate-300 rounded-lg focus:ring-law-navy focus:border-law-navy transition shadow-sm hover:shadow w-full text-slate-800"></select>
        </div>

        <div class="flex flex-col lg:col-span-2">
          <label for="categoria" class="text-slate-700 text-sm font-semibold mb-1">Categoria:</label>
          <select id="categoria" class="p-3 border border-slate-300 rounded-lg focus:ring-law-navy focus:border-law-navy transition shadow-sm hover:shadow w-full text-slate-800"></select>
        </div>

        <div class="flex flex-col lg:col-span-4">
          <label for="palavra" class="text-slate-700 text-sm font-semibold mb-1">Palavra-chave (Nº/Título/Ementa/Descrição):</label>
          <input id="palavra" type="text" placeholder="Ex.: orçamento, licitação, servidor"
                 class="p-3 border border-slate-300 rounded-lg focus:ring-law-navy focus:border-law-navy transition shadow-sm hover:shadow w-full text-slate-800">
        </div>
      </div>

      <!-- Header dos resultados + paginação -->
      <div class="p-5 bg-slate-50 rounded-t-xl shadow-inner border border-slate-200 border-b-0">
        <h2 class="text-lg sm:text-xl font-bold text-law-navy flex items-center gap-2 border-b pb-2 border-law-gold/50">
          <span>Resultados da pesquisa</span>
          <span class="text-slate-500 font-normal text-sm">(<span id="resultsCount">0</span> itens)</span>
        </h2>

        <div class="mt-3 flex flex-col sm:flex-row justify-between items-center gap-3">
          <div class="flex items-center gap-2">
            <label for="itemsPerPage" class="text-slate-700 text-sm font-semibold">Leis por página:</label>
            <select id="itemsPerPage" class="p-2 border border-slate-300 rounded-md focus:ring-law-navy focus:border-law-navy transition shadow-sm">
              <option>10</option>
              <option>20</option>
              <option>50</option>
              <option>100</option>
            </select>
          </div>
          <div id="paginationControls" class="flex items-center gap-2 flex-wrap justify-center">
            <button id="startIndexPageBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-900 font-semibold py-2 px-4 rounded-md transition text-sm disabled:opacity-50" disabled>Primeira</button>
            <button id="prevPageBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-900 font-semibold py-2 px-4 rounded-md transition text-sm disabled:opacity-50" disabled>Anterior</button>
            <span id="pageInfo" class="text-slate-700 text-sm font-medium">Página 1 de 1</span>
            <button id="nextPageBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-900 font-semibold py-2 px-4 rounded-md transition text-sm disabled:opacity-50" disabled>Próxima</button>
            <button id="endIndexPageBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-900 font-semibold py-2 px-4 rounded-md transition text-sm disabled:opacity-50" disabled>Última</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela rolável -->
    <div class="scroll-area overflow-y-auto overflow-x-auto rounded-b-xl shadow-md border border-slate-200 flex-grow">
      <table id="tabelaResultados" class="min-w-full table-fixed text-sm">
        <colgroup>
          <col class="col-ano" />
          <col class="col-numero" />
          <col class="col-tipo" />
          <col class="col-categoria" />
          <col class="col-descricao" />
          <col class="col-link" />
        </colgroup>
        <thead class="sticky top-0 z-10">
          <tr>
            <th id="anoHeader" class="bg-gradient-to-r from-law-navy to-law-navy2 text-white font-bold text-xs sm:text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer transition-colors">
              <div class="flex items-center justify-between pr-2">
                <span>Ano</span>
                <span id="sortIndicator" class="text-white/70"></span>
              </div>
            </th>
            <th class="bg-gradient-to-r from-law-navy to-law-navy2 text-white font-bold text-xs sm:text-sm uppercase tracking-wider">Número</th>
            <th class="bg-gradient-to-r from-law-navy to-law-navy2 text-white font-bold text-xs sm:text-sm uppercase tracking-wider">Tipo</th>
            <th class="bg-gradient-to-r from-law-navy to-law-navy2 text-white font-bold text-xs sm:text-sm uppercase tracking-wider">Categoria</th>
            <th class="bg-gradient-to-r from-law-navy to-law-navy2 text-white font-bold text-xs sm:text-sm uppercase tracking-wider">Descrição</th>
            <th class="bg-gradient-to-r from-law-navy to-law-navy2 text-white font-bold text-xs sm:text-sm uppercase tracking-wider rounded-tr-lg">Link</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="noResultsMessage" class="text-slate-600 text-center py-8 hidden bg-white rounded-b-lg">Nenhuma lei encontrada.</p>
    </div>
  </div>

  <script>
    // ======= Config =======
    const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGq5L060YUPjnfdEOHM5B_Y19bfy3uYVBmkkpuo1wu-PndIk5n3V49myUpm3vY6vFmEC0bqmGqDSle/pub?gid=0&single=true&output=csv";

    let allLaws = [];
    let filteredLaws = [];
    let currentPage = 1;
    let itemsPerPage = 10;
    let columnMap = {};
    let sortOrder = "desc"; // 'asc' | 'desc'

    // ======= Elements =======
    const tabelaResultadosBody = document.querySelector("#tabelaResultados tbody");
    const resultsCountSpan = document.getElementById("resultsCount");
    const loadingMessage = document.getElementById("loadingMessage");
    const errorMessage = document.getElementById("errorMessage");
    const noResultsMessage = document.getElementById("noResultsMessage");
    const localFileWarning = document.getElementById("localFileWarning");

    const itemsPerPageSelect = document.getElementById("itemsPerPage");
    const startIndexPageBtn = document.getElementById("startIndexPageBtn");
    const prevPageBtn = document.getElementById("prevPageBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");
    const pageInfoSpan = document.getElementById("pageInfo");
    const endIndexPageBtn = document.getElementById("endIndexPageBtn");

    const anoSelect = document.getElementById("ano");
    const tipoSelect = document.getElementById("tipo");
    const categoriaSelect = document.getElementById("categoria");
    const palavraInput = document.getElementById("palavra");
    const anoHeader = document.getElementById("anoHeader");
    const sortIndicator = document.getElementById("sortIndicator");

    // ======= Utils =======
    const escapeHTML = (str = "") =>
      str.replace(/[&<>"'`=\/]/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;" }[s]));

    const normalize = (s = "") =>
      s.normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase();

    const highlight = (text = "", query = "") => {
      if (!query) return text;
      const q = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      return text.replace(new RegExp(`(${q})`, "gi"), "<mark>$1</mark>");
    };

    function showErrorMessage(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove("hidden");
      loadingMessage.classList.add("hidden");
      noResultsMessage.classList.add("hidden");
    }
    function hideErrorMessage() { errorMessage.classList.add("hidden"); }

    // ======= Load CSV =======
    async function carregarDados() {
      loadingMessage.classList.remove("hidden");
      hideErrorMessage();
      tabelaResultadosBody.innerHTML = "";
      resultsCountSpan.textContent = "0";
      noResultsMessage.classList.add("hidden");

      if (window.location.protocol === "file:") {
        localFileWarning.classList.remove("hidden");
        showErrorMessage("Falha ao carregar a planilha. Restrição de segurança do navegador (CORS).");
        return;
      } else {
        localFileWarning.classList.add("hidden");
      }

      try {
        const resposta = await fetch(URL_CSV);
        if (!resposta.ok) throw new Error(`Erro de rede ou URL inválido: ${resposta.status} ${resposta.statusText}`);
        const rawCsvText = await resposta.text();
        allLaws = csvParaJSON(rawCsvText);
        popularFiltros();
        buscarLeis();
      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        showErrorMessage(`Falha ao carregar a planilha: ${error.message}. Verifique o URL e as permissões de publicação.`);
        tabelaResultadosBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-600 py-4">Erro ao carregar dados.</td></tr>`;
      } finally {
        loadingMessage.classList.add("hidden");
      }
    }

    function csvParaJSON(csv) {
      const linhas = csv.split("\n").map(l => l.replace(/\r$/, "").trim()).filter(Boolean);
      if (!linhas.length) return [];

      const headerIndex = linhas.findIndex(l =>
        l.toLowerCase().split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
         .some(col => col.trim() === "ano")
      );
      if (headerIndex === -1) return [];

      const headersRaw = linhas[headerIndex].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      const headers = headersRaw.map(h => h.replace(/^"|"$/g, "").trim().toLowerCase());

      columnMap = {
        ano: headers.find(h => h === "ano"),
        numero: headers.find(h => h === "número" || h === "numero"),
        tipo: headers.find(h => h === "tipo"),
        categoria: headers.find(h => h === "categoria"),
        descricao: headers.find(h => h === "descrição" || h === "descricao"),
        link: headers.find(h => h === "link da lei" || h === "link"),
      };

      return linhas.slice(headerIndex + 1).map(l => {
        const vals = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        const obj = {};
        headers.forEach((col, i) => { obj[col] = vals[i] ? vals[i].replace(/^"|"$/g, "").trim() : ""; });
        return obj;
      });
    }

    // ======= Filters =======
    function popularFiltros() {
      const mkOptions = (arr, labelAll) =>
        [`<option value="">${labelAll}</option>`, ...arr.map(v => `<option value="${escapeHTML(v)}">${escapeHTML(v)}</option>`)].join("");

      const anos = [...new Set(allLaws.map(it => it[columnMap.ano]).filter(Boolean))].sort((a,b)=> (parseInt(b)||0)-(parseInt(a)||0));
      anoSelect.innerHTML = mkOptions(anos, "Todos");

      const tipos = [...new Set(allLaws.map(it => it[columnMap.tipo]).filter(Boolean))].sort((a,b)=> a.localeCompare(b));
      tipoSelect.innerHTML = mkOptions(tipos, "Todos");

      const categorias = [...new Set(allLaws.map(it => it[columnMap.categoria]).filter(Boolean))].sort((a,b)=> a.localeCompare(b));
      categoriaSelect.innerHTML = mkOptions(categorias, "Todas");
    }

    // ======= Search =======
    function buscarLeis() {
      const anoFiltro = (anoSelect.value || "").trim();
      const tipoFiltro = normalize(tipoSelect.value || "");
      const categoriaFiltro = normalize(categoriaSelect.value || "");
      const palavraFiltro = normalize(palavraInput.value || "");

      filteredLaws = allLaws.filter(item => {
        const ano = (item[columnMap.ano] || "").trim();
        const tipo = normalize(item[columnMap.tipo] || "");
        const categoria = normalize(item[columnMap.categoria] || "");
        const desc = normalize(item[columnMap.descricao] || "");
        const numero = normalize(item[columnMap.numero] || "");
        const allText = `${tipo} ${categoria} ${desc} ${numero}`;

        const anoOk = !anoFiltro || ano === anoFiltro;
        const tipoOk = !tipoFiltro || tipo === tipoFiltro;
        const catOk = !categoriaFiltro || categoria === categoriaFiltro;
        const qOk = !palavraFiltro || allText.includes(palavraFiltro);

        return anoOk && tipoOk && catOk && qOk;
      });

      currentPage = 1;
      ordenarLeisPorAno();
    }

    function ordenarLeisPorAno() {
      if (!columnMap.ano) return;
      filteredLaws.sort((a, b) => {
        const A = parseInt(a[columnMap.ano], 10) || 0;
        const B = parseInt(b[columnMap.ano], 10) || 0;
        return sortOrder === "asc" ? A - B : B - A;
      });
      exibirLeisPaginadas();
    }

    // ======= Render/Pagination =======
    function exibirLeisPaginadas() {
      tabelaResultadosBody.innerHTML = "";
      noResultsMessage.classList.add("hidden");

      const totalPages = Math.ceil(filteredLaws.length / itemsPerPage) || 1;
      pageInfoSpan.textContent = `Página ${currentPage} de ${totalPages}`;

      const isFirst = currentPage === 1 || !filteredLaws.length;
      const isLast  = currentPage === totalPages || !filteredLaws.length;
      startIndexPageBtn.disabled = isFirst;
      prevPageBtn.disabled = isFirst;
      nextPageBtn.disabled = isLast;
      endIndexPageBtn.disabled  = isLast;

      sortIndicator.textContent = filteredLaws.length ? (sortOrder === "asc" ? "▲" : "▼") : "";

      if (!filteredLaws.length) {
        resultsCountSpan.textContent = "0";
        noResultsMessage.classList.remove("hidden");
        return;
      }

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = filteredLaws.slice(start, end);

      const qRaw = (palavraInput.value || "").trim();
      const qEscaped = escapeHTML(qRaw);

      pageItems.forEach((item, idx) => {
        const ano = escapeHTML(item[columnMap.ano] || "");
        const numero = escapeHTML(item[columnMap.numero] || "");
        const tipo = escapeHTML(item[columnMap.tipo] || "");
        const categoria = escapeHTML(item[columnMap.categoria] || "");
        const descricao = escapeHTML(item[columnMap.descricao] || "");
        const link = item[columnMap.link] || "#";

        const tr = document.createElement("tr");
        tr.className = idx % 2 === 0 ? "bg-white hover:bg-slate-50 transition-colors" : "bg-slate-50 hover:bg-slate-100 transition-colors";
        tr.innerHTML = `
          <td class="font-semibold text-slate-900 pr-2">${highlight(ano, qEscaped)}</td>
          <td class="text-slate-800 px-2">${highlight(numero, qEscaped)}</td>
          <td class="text-slate-800 px-2">${highlight(tipo, qEscaped)}</td>
          <td class="text-slate-800 px-2">${highlight(categoria, qEscaped)}</td>
          <td class="text-slate-800 px-2 break-words">${highlight(descricao, qEscaped)}</td>
          <td class="pl-2 pr-4">
            <a href="${link}" target="_blank"
               class="inline-flex items-center gap-2 bg-law-navy hover:bg-law-navy2 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:shadow-md transition text-xs sm:text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L14.414 5A2 2 0 0115 6.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1-3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
              </svg>
              Acessar
            </a>
          </td>
        `;
        tabelaResultadosBody.appendChild(tr);
      });

      resultsCountSpan.textContent = filteredLaws.length;
    }

    // ======= Events =======
    anoSelect.addEventListener("change", buscarLeis);
    tipoSelect.addEventListener("change", buscarLeis);
    categoriaSelect.addEventListener("change", buscarLeis);
    palavraInput.addEventListener("input", buscarLeis);

    itemsPerPageSelect.addEventListener("change", (e) => {
      itemsPerPage = parseInt(e.target.value, 10);
      currentPage = 1;
      exibirLeisPaginadas();
    });

    startIndexPageBtn.addEventListener("click", () => { currentPage = 1; exibirLeisPaginadas(); });
    prevPageBtn.addEventListener("click", () => { if (currentPage > 1) { currentPage--; exibirLeisPaginadas(); } });
    nextPageBtn.addEventListener("click", () => {
      const total = Math.ceil(filteredLaws.length / itemsPerPage);
      if (currentPage < total) { currentPage++; exibirLeisPaginadas(); }
    });
    endIndexPageBtn.addEventListener("click", () => {
      const total = Math.ceil(filteredLaws.length / itemsPerPage) || 1;
      currentPage = total; exibirLeisPaginadas();
    });

    anoHeader.addEventListener("click", () => {
      sortOrder = sortOrder === "asc" ? "desc" : "asc";
      ordenarLeisPorAno();
    });

    // ======= Init =======
    carregarDados();
  </script>
</body>
</html>
